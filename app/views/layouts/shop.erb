<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Online portfolio service for tattoo shops and artists.</title>
  <%= stylesheet_link_tag "global", "shops" %>
  <%= javascript_include_tag "jquery-1.4.2.min", "addon", "jquery.json-2.1" %>   
</head>
<body>

  <div id="wrapper">
     
  	<div id="header">
    	<h1 style="font-weight:bold">
        <%=h "#{@shop.name}: #{@shop.address}" %>
    	</h1>
    </div>

    <div style="padding-left:20px;">
      <ul class="main-tabs">
        <li><a href="#gallery" class="active" rel="tab-gallery">Gallery</a></li>
        <li><a href="#artists" rel="tab-artists">Artist Profiles</a></li>
        <li><a href="#artists" rel="tab-info">Hours | Directions | Contact</a></li>
      </ul>
    </div>

    <div id="top-container">
      <%= yield :top %>
    </div>   
        
    <div id="content_out" >
      <div id="content">

        <!-- Gallery tab -->
        <div id="tab-gallery" class="tab-content">
          <%= yield %>
        </div>
                
        <!-- Artists tab -->
        <div id="tab-artists" class="tab-content">
          <%= render :partial => @shop.artists %>
        </div>
        
        <!-- content tab -->
        <div id="tab-info" class="tab-content">
          <div class="shop-show">
            <%= render :partial => @shop %>
          </div>
        </div>
        
      </div>
    </div>
   
    <div id="footer">
      <%= link_to 'Shop Home', shop_path(@shop) %>
      | <%= link_to 'Add Artist', new_shop_artist_path(@shop) %>
      | <%= link_to 'Add Tattoo', new_shop_tattoo_path(@shop) %>
      | <%= link_to 'Edit Shop', edit_shop_path(@shop)  %>
      | <a href="#" class="toggle-shop">hide</a>
  		<p>&copy; 2010 Tastyink.com</p>
    </div>
    
  </div> 
  
  <!-- give javascript functions something to hook onto -->
  <span class="hooks" style="display:none">
    <%= link_to 'artists', artists_path , :class => 'do-artist' %>
    <%= link_to 'Shop Profile', @shop, :class => 'do-shop' %>
  </span>
  <!-- end -->
  

<script type="text/javascript">
// setup assets
  assetUrl = 'http://localhost:3000/system/datas/';
  function shopTemplate(s){return '<%= js_shop_template %>'};
  function artistTemplate(a){return '<%= js_artist_template %>'};
  function tattooTemplate(t, a){return '<%= js_tattoo_template %>'};
  function tattoosTemplate(t){return '<%= js_tattoos_template %>'};

// populate the main window
  function tastyMain(type, url){
    $('div.gallery-full').html('<div class="loading">Loading...</div>');
    $.get(url +'.json', function(rsp){
      switch(type){
        case 'shops':
          var data = shopTemplate(rsp.shop);
          var assets = rsp.shop.assets;
        break;
        case 'artists':
          var data = artistTemplate(rsp.artist);
          var assets = rsp.artist.assets;
        break;        
        case 'tattoos':
          var data = tattooTemplate(rsp.tattoo, rsp.tattoo.artist);
          var assets = rsp.tattoo.assets;
        break;        
      }
      $('div.gallery-full').html(data);
      
      // load thumb assets.
      console.log(assets.length);
      var tinys = '';
      for (var i = 0; i < assets.length; i++){
        tinys += '<img src="/system/datas/' + assets[i].id +'/thumb/'+ assets[i].data_file_name +'" >';
      }
      $('div.gallery-full span#assets').html(tinys);
    });
  }
   
     
// activate tab navigation
  $('ul.main-tabs li a').click(function(){
    $('div.tab-content').hide();
    $('ul.main-tabs li a').removeClass('active');
    $(this).addClass('active');
    $('div#'+ $(this).attr('rel')).show();
    return false;
  });
  $('ul.main-tabs li a:first').click();


// delegate gallery environment
  $('body').click($.delegate({

   // iterate through tattoo pics.
    'span#assets img' : function(e){
       var src = $(e.target).attr('src').replace('/thumb/','/gallery/');
       $('div.gallery-images').html('<img src="' + src + '" >');
       return false;
    }, 
      
   // display shop profile
    'a.do-shop' : function(e){
      tastyMain('shops', e.target.href);
      return false;    
    },
 
   // display artist profile
    'a.do-artist' : function(e){
      tastyMain('artists', e.target.href);
      return false;    
    },
    
   // display tattoo profile (for gallery)
    'div.gallery-scroller a' : function(e){
      $('div.gallery-scroller a').removeClass('active');
      $(e.target).addClass('active');
      tastyMain('tattoos', e.target.href);
      return false;
    },
    // helper so tattoo thumb images can delegate.
      'div.gallery-scroller a img' : function(e){
        $(e.target).parent('a').click();
        return false;
      },
    
    
   // display artist tattoos gallery
    'a.do-artist-tattoos' : function(e){
      $('div.gallery-scroller').html('<div class="loading white">Loading...</div>');
      $('ul.artists-list li a').removeClass('active');
      var rel = $(e.target).attr('rel');
      $('ul.artists-list li a[rel='+ rel +']').addClass('active');
      
      $.get(e.target.href +'.json', function(rsp){
        $('div.gallery-scroller').empty();
        $.each(rsp, function(){
          //NOTE: should filter out tattoos with no images server side.
          if (this.tattoo.assets.length <= 0) return;
          $('div.gallery-scroller').append(tattoosTemplate(this.tattoo));
        });
      });
       
      // load artist or shop profile
      if(rel)
        $('span.hooks a.do-artist').attr('href', '<%= artists_path %>/' + rel).click();
      else
        $('span.hooks a.do-shop').click();
      return false;    
    },
 
   // toggle details box
    'a.toggle-details' : function(e){
      $('div.gallery-body').toggle();
      return false;
    }  
         
   }));
   
  // overload artist tab links to load gallery
  $('#tab-artists .artist-each a.do-artist').click(function(){
    $('ul.main-tabs li a:first').click();
  });

  //$.evalJSON();
</script>


</body>
</html>
